<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reciclaje Inteligente - Escaneo</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <style>
        /* Estilos generales del cuerpo */
        body {
            background-color: #f0f8f0; /* Fondo verde claro */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Fuente moderna y legible */
        }
        /* Contenedor principal para centrar el contenido */
        .container {
            max-width: 600px;
        }
        /* Estilo para el contenedor del escáner y la tarjeta de resultados */
        .scan-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra suave */
            padding: 20px;
            margin-top: 20px;
        }
        /* Vista del escáner */
        .scanner-view {
            width: 100%;
            margin: 0 auto;
            border: 3px solid #28a745; /* Borde verde distintivo */
            border-radius: 8px;
            overflow: hidden;
            height: 300px; /* Altura fija para la vista del escáner */
            position: relative;
        }
        /* Asegura que los elementos del escáner llenen su contenedor */
        #qr-scanner, #barcode-scanner {
            width: 100%;
            height: 100%;
        }
        /* Placeholder para cuando el escáner de código de barras se está inicializando */
        .scanner-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background-color: #f8f9fa;
            color: #6c757d;
        }
        /* Opciones de escaneo (botones QR/Código de Barras) */
        .scan-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .scan-option-btn {
            padding: 10px 20px;
            border-radius: 30px; /* Botones redondeados */
            font-weight: bold;
            border: 2px solid transparent;
            transition: all 0.3s; /* Transición suave para efectos hover */
        }
        .scan-option-btn.active {
            background-color: #2e7d32; /* Verde oscuro para el activo */
            color: white;
            border-color: #2e7d32;
        }
        .scan-option-btn:not(.active) {
            background-color: white;
            color: #2e7d32;
            border-color: #2e7d32;
        }
        .scan-option-btn:not(.active):hover {
            background-color: #e8f5e9; /* Fondo verde claro al pasar el ratón */
        }
        /* Tarjeta de resultados del escaneo */
        .result-card {
            display: none; /* Oculto por defecto */
            margin-top: 20px;
            animation: fadeIn 0.5s; /* Animación de aparición */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Información del material identificado */
        .material-info {
            background-color: #e8f5e9;
            border-left: 4px solid #2e7d32; /* Borde izquierdo verde */
            padding: 15px;
            border-radius: 0 5px 5px 0;
        }
        /* Insignia de puntos ganados */
        .points-badge {
            font-size: 1.2rem;
            padding: 8px 15px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32); /* Degradado verde */
            border-radius: 20px; /* Bordes redondeados */
            color: white;
        }
        /* Botones de acción (no usados en este HTML, pero mantenidos por si acaso) */
        .btn-scan {
            background-color: #2e7d32;
            color: white;
            font-weight: bold;
            padding: 10px 25px;
            border-radius: 30px;
            border: none;
            transition: all 0.3s;
        }
        .btn-scan:hover {
            background-color: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Indicador de estado del escáner */
        .status-indicator {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active {
            background-color: #4CAF50;
            animation: pulse 1.5s infinite; /* Animación de pulsación */
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        /* Botón de regresar */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<a th:href="@{/dashboard}" class="btn btn-outline-secondary back-button">
    <i class="fas fa-arrow-left"></i> Regresar
</a>

<div class="container py-4">
    <div class="text-center mb-4">
        <h2 class="text-success"><i class="fas fa-recycle"></i> Reciclaje Inteligente</h2>
        <p class="text-muted">Escanea tu material reciclable para ganar puntos</p>
    </div>
    
    <div class="scan-options">
        <button id="qrOption" class="scan-option-btn active">
            <i class="fas fa-qrcode"></i> Escanear QR
        </button>
        <button id="barcodeOption" class="scan-option-btn">
            <i class="fas fa-barcode"></i> Escanear Código de Barras
        </button>
    </div>
    
    <div class="scan-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><span class="status-indicator status-active"></span> Escáner activo</h4>
            <span class="badge bg-secondary">Beta</span>
        </div>
        
        <div class="scanner-view">
            <div id="qr-scanner"></div>
            <div id="barcode-scanner" style="display: none;">
                <div class="scanner-placeholder">
                    <p>Preparando escáner de códigos de barras...</p>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <button id="toggleCamera" class="btn btn-outline-success btn-sm">
                <i class="fas fa-camera"></i> Cambiar cámara
            </button>
        </div>
        
        <div class="alert alert-info mt-3" role="alert">
            <i class="fas fa-info-circle"></i> Coloca el código frente a la cámara. Asegúrate de que esté bien iluminado.
        </div>
    </div>
    
    <div id="resultCard" class="result-card scan-container">
        <h4 class="mb-3"><i class="fas fa-check-circle text-success"></i> Material identificado</h4>
        
        <div class="material-info mb-3">
            <h5 id="materialName">Cargando información...</h5>
            <p id="materialDescription" class="mb-1"></p>
            <p><span class="text-muted">Categoría:</span> <span id="materialCategory"></span></p>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-group mb-0">
                <label for="materialQuantity" class="form-label text-muted">Cantidad:</label>
                <input type="number" id="materialQuantity" class="form-control" value="1" min="1" style="width: 80px; display: inline-block;">
            </div>
            <div>
                <span class="text-muted">Puntos totales:</span>
                <span id="pointsEarned" class="points-badge badge ms-2">+10</span>
            </div>
        </div>
        
        <div id="confirmationButtons" class="d-none text-end">
            <button id="confirmBtn" class="btn btn-success btn-sm">
                <i class="fas fa-check"></i> Confirmar
            </button>
            <button id="cancelBtn" class="btn btn-outline-danger btn-sm ms-2">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>
    
    <div id="loadingSpinner" class="text-center mt-4 d-none">
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Procesando material reciclable...</p>
    </div>
    
    <div id="successMessage" class="alert alert-success mt-3 d-none" role="alert">
        <i class="fas fa-check-circle"></i> ¡Material registrado con éxito!
    </div>
     <div id="errorMessage" class="alert alert-danger mt-3 d-none" role="alert">
        <i class="fas fa-exclamation-triangle"></i> Hubo un error al registrar el material.
    </div>
</div>

<script>
    // Referencias a elementos del DOM
    const resultCard = document.getElementById('resultCard');
    const materialName = document.getElementById('materialName');
    const materialDescription = document.getElementById('materialDescription');
    const materialCategory = document.getElementById('materialCategory');
    const materialQuantityInput = document.getElementById('materialQuantity');
    const pointsEarned = document.getElementById('pointsEarned');
    const confirmationButtons = document.getElementById('confirmationButtons');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const toggleCameraBtn = document.getElementById('toggleCamera');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const qrOption = document.getElementById('qrOption');
    const barcodeOption = document.getElementById('barcodeOption');
    const qrScannerElement = document.getElementById('qr-scanner');
    const barcodeScannerElement = document.getElementById('barcode-scanner');
    
    // Estado de la aplicación
    let currentCamera = 'environment'; // 'environment' (trasera) o 'user' (frontal)
    let html5QrCode;
    let quaggaInitialized = false;
    let lastScannedCode = null; // Para evitar múltiples detecciones rápidas del mismo código
    let currentScanner = 'qr'; // 'qr' o 'barcode'
    let lastScannedMaterialData = null; // Para guardar los datos del material escaneado antes de enviar

    /**
     * Inicializa y comienza el escáner QR.
     */
    function initQRScanner() {
        // Si el escáner ya está instanciado, solo lo reanuda
        if (html5QrCode) {
            html5QrCode.resume();
            return;
        }
        
        html5QrCode = new Html5Qrcode("qr-scanner");
        
        const config = { 
            fps: 10, // Cuadros por segundo
            qrbox: { width: 250, height: 250 } // Área de escaneo del QR
        };
        
        html5QrCode.start(
            { facingMode: currentCamera }, // Usa la cámara seleccionada
            config,
            onScanSuccess, // Callback para éxito de escaneo
            onScanError // Callback para errores de escaneo
        ).catch(err => {
            console.error("Error al iniciar el escáner QR:", err);
            // Muestra un mensaje amigable si la cámara no puede ser accedida
            alert("No se pudo acceder a la cámara. Por favor, asegúrate de haber dado los permisos necesarios.");
        });
    }
    
    /**
     * Inicializa y comienza el escáner de códigos de barras (QuaggaJS).
     */
    function initBarcodeScanner() {
        // Si Quagga ya está inicializado, solo lo inicia
        if (quaggaInitialized) {
            Quagga.start();
            return;
        }
        
        Quagga.init({
            inputStream: {
                type: "LiveStream", // Usa el stream de la cámara en vivo
                target: barcodeScannerElement, // Elemento DOM donde se mostrará la vista de la cámara
                constraints: {
                    facingMode: currentCamera,
                    width: { min: 640 },
                    height: { min: 480 },
                    aspectRatio: { min: 1, max: 2 }
                },
            },
            decoder: {
                readers: [ // Tipos de códigos de barras a detectar
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "upc_reader",
                ]
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            locate: true, // Habilitar la localización visual del código de barras
            frequency: 10 // Frecuencia de detección
        }, function(err) {
            if (err) {
                console.error("Error al iniciar Quagga:", err);
                alert("No se pudo iniciar el escáner de códigos de barras.");
                return;
            }
            quaggaInitialized = true;
            Quagga.start();
            
            // Oculta el placeholder una vez que el escáner está listo
            const placeholder = barcodeScannerElement.querySelector('.scanner-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        });
        
        // Listener para cuando se detecta un código de barras
        Quagga.onDetected(function(data) {
            const code = data.codeResult.code;
            console.log(`Código de barras detectado: ${code}`);
            handleDetectedCode(code);
        });
    }
    
    /**
     * Cambia entre el escáner QR y el escáner de Código de Barras.
     * @param {string} type - 'qr' o 'barcode'.
     */
    function toggleScanner(type) {
        if (type === currentScanner) return; // No hacer nada si ya está en el tipo seleccionado
        
        // Detener el escáner actualmente activo
        if (currentScanner === 'qr') {
            if (html5QrCode) {
                html5QrCode.pause(); // Pausa el escáner QR
            }
        } else {
            if (quaggaInitialized) {
                Quagga.stop(); // Detiene el escáner de código de barras
            }
        }
        
        // Actualizar la interfaz de usuario (clases CSS y visibilidad)
        qrOption.classList.toggle('active', type === 'qr');
        barcodeOption.classList.toggle('active', type === 'barcode');
        qrScannerElement.style.display = type === 'qr' ? 'block' : 'none';
        barcodeScannerElement.style.display = type === 'barcode' ? 'block' : 'none';
        
        // Actualizar el estado del escáner actual
        currentScanner = type;
        
        // Iniciar el nuevo escáner
        if (type === 'qr') {
            initQRScanner();
        } else {
            initBarcodeScanner();
        }
    }
    
    /**
     * Callback para cuando el escáner QR detecta un código.
     * @param {string} decodedText - El texto decodificado del QR.
     * @param {object} decodedResult - El resultado completo del escodificado.
     */
    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Código QR detectado: ${decodedText}`);
        handleDetectedCode(decodedText);
    }
    
    /**
     * Procesa el código detectado (ya sea QR o de barras).
     * Ahora, intentará parsear como JSON o hará una llamada al backend.
     * @param {string} code - El código detectado.
     */
    async function handleDetectedCode(code) {
        // Implementa un "debounce" simple para evitar procesar el mismo código múltiples veces rápidamente
        if (code === lastScannedCode) return;
        
        lastScannedCode = code; // Guarda el último código escaneado
        
        // Detener temporalmente el escáner para evitar más detecciones
        if (currentScanner === 'qr' && html5QrCode) {
            html5QrCode.pause();
        } else if (currentScanner === 'barcode' && quaggaInitialized) {
            Quagga.stop();
        }

        // Limpiar mensajes anteriores y mostrar spinner de carga
        successMessage.classList.add('d-none');
        errorMessage.classList.add('d-none');
        loadingSpinner.classList.remove('d-none');
        resultCard.style.display = 'none'; // Ocultar la tarjeta de resultados mientras se busca

        let material = null;
        try {
            // 1. Intentar parsear el código como JSON (para QR que contienen datos estructurados)
            if (currentScanner === 'qr') {
                const parsedJson = JSON.parse(code);
                // Validar que el JSON tenga las propiedades esperadas de un material
                if (parsedJson.nombre && parsedJson.categoria && parsedJson.puntosPorUnidad && parsedJson.codigoBarra) {
                    material = parsedJson;
                }
            }
        } catch (e) {
            console.log("El código no es un JSON válido, intentando buscar en el backend.");
        }

        // 2. Si no se obtuvo el material del JSON, intentar buscarlo en el backend por el código
        if (!material) {
            try {
                const lookupEndpoint = `/api/materiales/buscar-por-codigo?codigo=${code}`; // Nuevo endpoint en tu backend
                console.log("Buscando material en el backend:", lookupEndpoint);

                const response = await fetch(lookupEndpoint, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    material = await response.json();
                } else if (response.status === 404) {
                    console.log("Material no encontrado en el backend.");
                    material = null; // Asegurarse de que material sea null si no se encuentra
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Error desconocido al buscar material en el backend.');
                }
            } catch (err) {
                console.error("Error al buscar material en el backend:", err);
                errorMessage.textContent = err.message || "Ocurrió un error al buscar el material. Intenta de nuevo.";
                errorMessage.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
                // Reanudar escáner si hubo un error de red o similar
                setTimeout(() => {
                    errorMessage.classList.add('d-none');
                    if (currentScanner === 'qr') { html5QrCode.resume(); } else if (quaggaInitialized) { Quagga.start(); }
                }, 3000);
                return; // Salir de la función
            }
        }

        // 3. Mostrar la información del material si se encontró
        loadingSpinner.classList.add('d-none'); // Ocultar spinner
        if (material) {
            lastScannedMaterialData = material; // Guardar los datos para el envío al backend
            displayMaterialInfo(material); // Muestra la información del material en la interfaz
        } else {
            // Material no encontrado o QR no válido
            materialName.textContent = "Material no reconocido";
            materialDescription.textContent = "Este código no está registrado en nuestro sistema. Por favor, verifica el código.";
            materialCategory.textContent = "";
            pointsEarned.textContent = "+0";
            confirmationButtons.classList.remove('d-none');
            resultCard.style.display = 'block';
            lastScannedMaterialData = null; // Resetea los datos si no se reconoce el material
        }
    }
    
    /**
     * Muestra la información del material en la tarjeta de resultados.
     * @param {object} material - Objeto con los datos del material.
     */
    function displayMaterialInfo(material) {
        resultCard.style.display = 'block'; // Muestra la tarjeta de resultados
        
        materialName.textContent = material.nombre;
        materialDescription.textContent = material.descripcion;
        materialCategory.textContent = material.categoria;
        
        // Establece la cantidad por defecto a 1 y actualiza los puntos totales
        materialQuantityInput.value = 1;
        updateTotalPoints();

        confirmationButtons.classList.remove('d-none'); // Muestra los botones de confirmación
    }

    /**
     * Actualiza los puntos totales mostrados en función de la cantidad y los puntos por unidad.
     */
    function updateTotalPoints() {
        if (lastScannedMaterialData) {
            const quantity = parseInt(materialQuantityInput.value);
            const pointsPerUnit = lastScannedMaterialData.puntosPorUnidad;
            const totalPoints = pointsPerUnit * quantity;
            pointsEarned.textContent = `+${totalPoints}`;
        }
    }

    // Agrega un listener al input de cantidad para actualizar los puntos en tiempo real
    materialQuantityInput.addEventListener('input', updateTotalPoints);
    
    /**
     * Callback para manejar errores del escáner (se comenta para evitar ruido en consola).
     * @param {string} errorMessage - Mensaje de error del escáner.
     */
    function onScanError(errorMessage) {
        // console.log("Error en el escáner:", errorMessage); // Demasiado ruidoso, comentar en producción
    }
    
    /**
     * Cambia la cámara activa (frontal/trasera) y reinicia el escáner.
     */
    async function toggleCamera() {
        try {
            // Detener el escáner activo antes de cambiar
            if (currentScanner === 'qr' && html5QrCode) {
                await html5QrCode.stop();
            } else if (currentScanner === 'barcode' && quaggaInitialized) {
                Quagga.stop();
            }
            
            // Alternar entre 'environment' (trasera) y 'user' (frontal)
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            
            // Reiniciar el escáner con la nueva cámara
            if (currentScanner === 'qr') {
                initQRScanner();
            } else {
                initBarcodeScanner();
            }
            
            // Actualizar el texto del botón para indicar la cámara actual
            const cameraName = currentCamera === 'environment' ? 'Trasera' : 'Frontal';
            toggleCameraBtn.innerHTML = `<i class="fas fa-camera"></i> Cámara ${cameraName}`;
            
        } catch (err) {
            console.error("Error al cambiar de cámara:", err);
            alert("No se pudo cambiar la cámara. Intenta de nuevo.");
        }
    }
    
    /**
     * Confirma el reciclaje, envía los datos al backend y maneja la respuesta.
     */
    async function confirmRecycling() {
        if (!lastScannedMaterialData) {
            alert("No hay datos de material para registrar.");
            return;
        }

        const quantity = parseInt(materialQuantityInput.value);
        if (isNaN(quantity) || quantity < 1) {
            alert("Por favor, introduce una cantidad válida (mínimo 1).");
            return;
        }

        // Ocultar mensajes anteriores y mostrar spinner de carga
        successMessage.classList.add('d-none');
        errorMessage.classList.add('d-none');
        loadingSpinner.classList.remove('d-none');
        resultCard.style.display = 'none';
        confirmationButtons.classList.add('d-none');
        
        try {
            // El endpoint para crear un NUEVO material desde QR/Código de Barras
            const endpoint = '/api/reciclajes/crear-desde-qr'; 
            
            // Construir el payload con la estructura JSON esperada por tu backend (MaterialScanRequest DTO)
            const payload = {
                qrData: JSON.stringify(lastScannedMaterialData), // JSON string del material
                quantity: quantity // Cantidad de unidades
            };
            
            console.log("Enviando a la API:", payload);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest' // Importante para Spring Security CSRF
                },
                body: JSON.stringify(payload),
                credentials: 'include' // Para incluir cookies de sesión (importante para Spring Security)
            });
            
            const responseData = await response.json(); // Leer la respuesta como JSON
            
            if (!response.ok) {
                // Si la respuesta HTTP no es 2xx OK, lanzar un error
                throw new Error(responseData.message || responseData.error || 'Error desconocido al registrar el material');
            }
            
            // Si la respuesta es exitosa, mostrar mensaje de éxito
            successMessage.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                ¡Material "${responseData.material.nombre}" (${quantity} unidades) registrado con éxito! Ganaste ${responseData.pointsEarned} puntos.
            `;
            loadingSpinner.classList.add('d-none');
            successMessage.classList.remove('d-none');
            
        } catch (err) {
            console.error("Error al registrar material:", err);
            loadingSpinner.classList.add('d-none');
            errorMessage.textContent = err.message || "Ocurrió un error al registrar tu material. Intenta de nuevo.";
            errorMessage.classList.remove('d-none');
            resultCard.style.display = 'block'; // Volver a mostrar la tarjeta de resultados con el error
            confirmationButtons.classList.remove('d-none');
        } finally {
            // Reiniciar el escáner y limpiar el estado después de un tiempo
            setTimeout(() => {
                successMessage.classList.add('d-none');
                errorMessage.classList.add('d-none');
                lastScannedCode = null; // Resetea el último código escaneado
                lastScannedMaterialData = null; // Resetea los datos del material

                // Reanuda el escáner activo
                if (currentScanner === 'qr') {
                    initQRScanner();
                } else if (quaggaInitialized) {
                    Quagga.start();
                }
            }, 5000); // Da tiempo para leer el mensaje antes de reiniciar
        }
    }

    /**
     * Cancela el escaneo, oculta la tarjeta de resultados y reinicia el escáner.
     */
    function cancelScan() {
        resultCard.style.display = 'none';
        confirmationButtons.classList.add('d-none');
        lastScannedCode = null;
        lastScannedMaterialData = null;
        
        // Limpiar cualquier mensaje de éxito/error anterior
        successMessage.classList.add('d-none');
        errorMessage.classList.add('d-none');

        // Reanuda el escáner activo
        if (currentScanner === 'qr') {
            html5QrCode.resume();
        } else if (quaggaInitialized) {
            Quagga.start();
        }
    }
    
    // Asignación de Event Listeners a los botones
    toggleCameraBtn.addEventListener('click', toggleCamera);
    confirmBtn.addEventListener('click', confirmRecycling);
    cancelBtn.addEventListener('click', cancelScan);
    qrOption.addEventListener('click', () => toggleScanner('qr'));
    barcodeOption.addEventListener('click', () => toggleScanner('barcode'));
    
    // Iniciar la aplicación cuando el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', () => {
        initQRScanner(); // Inicia el escáner QR por defecto
    });
</script>
</body>
</html>